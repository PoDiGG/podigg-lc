'use strict';

const Podigg = require('podigg');
const childProcess = require('child_process');
const fs = require('fs');

// Generate GTFS
var path = process.argv.length < 3 ? '.' : process.argv[2];
var generator = Podigg.fromEnvironmentVariables();
generator.generate(path);

function prefixZero(element) {
    return element < 10 ? "0" + element : element;
}

function timestampToDate(timestamp) {
    var date = new Date(timestamp);
    return date.getFullYear() + "" + prefixZero(date.getMonth() + 1) + "" + prefixZero(date.getDate());
}

// A small timeout to ensure the gtfs output files have been flushed.
// TODO: find a better way to do this...
setTimeout(() => {
    // Convert GTFS to LC
    var startDate = timestampToDate(generator.options['connections:time_initial'] || 0);
    var endDate = timestampToDate(generator.options['connections:time_final'] || (24 * 3600000 * 31));
    var p = childProcess.spawn('./node_modules/gtfs2lc/bin/gtfs2lc.js', [path + '/gtfs', '-f', 'turtle', '-r', '-t', '-a', '-s', startDate, '-e', endDate]);
    p.stdout.pipe(fs.createWriteStream(path + '/lc.ttl'));
    p.stderr.pipe(process.stderr);
}, 1000);
